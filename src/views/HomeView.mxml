<?xml version="1.0" encoding="utf-8"?>
<!--
Copyright (C) 2016  Johan Degraeve

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/gpl.txt>.

-->
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark" title=""
		initialize="initializeHandler(event)"
		creationComplete="onCreationComplete(event)">
	<fx:Script>
		<![CDATA[
			import com.distriqt.extension.bluetoothle.BluetoothLE;
			import com.distriqt.extension.bluetoothle.BluetoothLEState;
			import com.distriqt.extension.bluetoothle.events.BluetoothLEEvent;
			import com.distriqt.extension.bluetoothle.events.PeripheralEvent;
			import com.distriqt.extension.bluetoothle.objects.PeripheralState;
			import com.distriqt.extension.dialog.Dialog;
			import com.distriqt.extension.dialog.DialogView;
			import com.distriqt.extension.dialog.builders.ActionSheetBuilder;
			import com.distriqt.extension.dialog.builders.AlertBuilder;
			import com.distriqt.extension.dialog.events.DialogViewEvent;
			import com.distriqt.extension.dialog.objects.DialogAction;
			
			import mx.events.FlexEvent;
			
			import Utilities.BgGraphBuilder;
			
			import databaseclasses.BgReading;
			import databaseclasses.BlueToothDevice;
			import databaseclasses.Calibration;
			import databaseclasses.Database;
			import databaseclasses.Sensor;
			
			import events.BlueToothServiceEvent;
			import events.CalibrationServiceEvent;
			import events.DatabaseEvent;
			import events.TransmitterServiceEvent;
			
			import model.ModelLocator;
			
			import services.BluetoothService;
			import services.CalibrationService;
			import services.DialogService;
			import services.TransmitterService;
			
			private static var initialStart:Boolean = true;
			[Bindable]
			private static var currentBgLabelText:String = "---";
			[Bindable]
			private static var _calibrateButtonActive:Boolean = false;
			private static const ACTION_SHEET_INDEX_FOR_SCAN_FOR_DEVICE:int = 0;
			private static const ACTION_SHEET_INDEX_FOR_FORGET_DEVICE:int = 1;
			private static const ACTION_SHEET_INDEX_FOR_START_SENSOR:int = 2;
			private static const ACTION_SHEET_INDEX_FOR_STOP_SENSOR:int = 3;
			private static const ACTION_SHEET_INDEX_FOR_STATUS:int = 4;
			private static const ACTION_SHEET_INDEX_FOR_CONNECT_TO_DEVICE:int = 5;
			private static const ACTION_SHEET_INDEX_FOR_CANCEL:int = 5;
			
			[ResourceBundle("homeview")]
			[ResourceBundle("general")]
			
			protected function onCreationComplete(event:FlexEvent):void
			{
				if (initialStart) {
					Database.instance.addEventListener(DatabaseEvent.DATABASE_INIT_FINISHED_EVENT,onInitResult);
					Database.instance.addEventListener(DatabaseEvent.ERROR_EVENT,onInitError);
					Database.instance.addEventListener(DatabaseEvent.DATABASE_INFORMATION_EVENT, databaseInformationEventReceived);
					//need to know when modellocator is populated, then we can also update display
					Database.instance.addEventListener(DatabaseEvent.BGREADING_RETRIEVAL_EVENT, bgReadingReceivedFromDatabase);
					Database.init();
					initialStart = false;
				} else {
					//force now a check if the icon needs tobe changed by calling bluetoothStateChangedHandler, even though it may not have changed
					bluetoothStateChangedHandler(null);
				}
				
				function bgReadingReceivedFromDatabase(de:DatabaseEvent):void {
					if (de.data != null)
						if (de.data is String) {
							if (de.data as String == Database.END_OF_RESULT) {
								Database.instance.removeEventListener(DatabaseEvent.BGREADING_RETRIEVAL_EVENT, bgReadingReceivedFromDatabase);
								displayCurrentInfoFromReading(BgReading.lastNoSensor());
							}
						}
				} 
				
				function onInitResult(event:Event):void
				{
					trace("HomeView : database init result ok");
					Database.instance.removeEventListener(DatabaseEvent.ERROR_EVENT, onInitError);
					Database.instance.removeEventListener(DatabaseEvent.DATABASE_INIT_FINISHED_EVENT, onInitResult);
					//at this moment the database is intialised, but the logs, bgreadings, ... might still be read in the ModelLocator, Modellocator is listening to the same event
					
					//will initialise the bluetoothdevice
					Database.getBlueToothDevice();
					
					//set calibration button in the correct state
					if (Calibration.allForSensor().length > 1) {
						_calibrateButtonActive = true;
					}
					
					BluetoothService.instance.addEventListener(BlueToothServiceEvent.BLUETOOTH_SERVICE_INFORMATION_EVENT, blueToothServiceInformationReceived);
					BluetoothService.instance.addEventListener(BlueToothServiceEvent.BLUETOOTH_SERVICE_INITIATED, blueToothServiceInitiated);

					TransmitterService.instance.addEventListener(TransmitterServiceEvent.BGREADING_EVENT, transmitterServiceBGReadingEventReceived);
					
					CalibrationService.instance.addEventListener(CalibrationServiceEvent.INITIAL_CALIBRATION_EVENT, initialCalibrationEventReceived);
					CalibrationService.instance.addEventListener(CalibrationServiceEvent.NEW_CALIBRATION_EVENT, newCalibrationEventReceived);
				}
				
				function onInitError(event:Event):void
				{	
					Database.instance.removeEventListener(DatabaseEvent.ERROR_EVENT, onInitError);
					Database.instance.removeEventListener(DatabaseEvent.DATABASE_INIT_FINISHED_EVENT, onInitResult);
					trace("HomeView : database init error");
				}
			}
			
			private function central_peripheralConnectHandler(event:PeripheralEvent):void {
				bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_green);
			}
			
			private function central_peripheralDisconnectHandler(event:PeripheralEvent):void {
				if ((BluetoothLE.service.centralManager.state == BluetoothLEState.STATE_ON) && BlueToothDevice.known()) {
					bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_orange);
				} else {
					bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_red);
				}
			}
			
			private function bluetoothStateChangedHandler(event:BluetoothLEEvent):void {
				if (BluetoothLE.service.centralManager.state == BluetoothLEState.STATE_ON) {
					if (BluetoothService.bluetoothPeripheralActive()) {
						if (BluetoothService.getActiveBluetoothPeripheral().state == PeripheralState.CONNECTED) {
							//peripheral is known in bluetoothservice and it is connected
							bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_green);
						} else {
							//peripheral is known, but not active, orange
							bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_orange);
						}
					} else {//bluetoothperipheral not known in bluetoothservice, but maybe a device name is known in bluetoothdevice
						if (BlueToothDevice.known()) {
							//we know a device, we just didn't scan it yet, good for orange
							bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_orange);
						} else {
							//we don't know a device yet, scanning for new device still needs to happen, that's red 
							bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_red);
						}
					}
				} else {
					//definitely a case for red, because bluetooth is not on
					bluetoothButton.setStyle("icon", ModelLocator.image_bluetooth_red);
				}
			}
			
			private function blueToothServiceInformationReceived(be:BlueToothServiceEvent):void {
				trace((new Date()).toTimeString() + " : HomeView : received bluetooth service information = " + be.data.information);
			}
			
			private function blueToothServiceInitiated(be:BlueToothServiceEvent):void {
				BluetoothService.instance.removeEventListener(BlueToothServiceEvent.BLUETOOTH_SERVICE_INITIATED, blueToothServiceInitiated);
				BluetoothLE.service.centralManager.addEventListener(PeripheralEvent.CONNECT, central_peripheralConnectHandler);
				BluetoothLE.service.centralManager.addEventListener(PeripheralEvent.DISCONNECT, central_peripheralDisconnectHandler);
				BluetoothLE.service.addEventListener(BluetoothLEEvent.STATE_CHANGED, bluetoothStateChangedHandler);
				//bluetooth service is initiated
				//force now a check if the icon needs tobe changed by calling bluetoothStateChangedHandler, even though it may not have changed
				bluetoothStateChangedHandler(null);
			}
			
			private function transmitterServiceBGReadingEventReceived(be:TransmitterServiceEvent):void {
				displayCurrentInfoFromReading(BgReading.lastNoSensor());
			}
			
			private function initialCalibrationEventReceived(be:CalibrationServiceEvent):void {
				displayCurrentInfoFromReading(BgReading.lastNoSensor());
				_calibrateButtonActive = true;
			}
			
			private function newCalibrationEventReceived(be:CalibrationServiceEvent):void {
				displayCurrentInfoFromReading(BgReading.lastNoSensor());
			}
			
			private function databaseInformationEventReceived(be:DatabaseEvent):void {
				//trace((new Date()).toTimeString() + " : HomeView : received database  information = " + be.data.information);
			}
			
			protected function initializeHandler(event:FlexEvent):void
			{
				//instantiate modellocator because event listeners are being added to the database class, to receive logging information
				ModelLocator.instance;
			}
			
			private function displayCurrentInfoFromReading(lastBgReading:BgReading):void {
				var estimate:Number = new Number(0);
				if (lastBgReading == null) {
					currentBgLabelText = "---";
					currentBgLabel.setStyle("lineThrough","false");
				} else {
					if ((new Date().getTime()) - (60000 * 11) - lastBgReading.timestamp > 0) {
						//notificationText = ModelLocator.resourceManagerInstance.getString('homeview','signalmissed');
						estimate = lastBgReading.calculatedValue;
						currentBgLabelText = BgGraphBuilder.unitizedString(estimate, true);
						currentBgLabel.setStyle("lineThrough","true");
					} else {
						/*if (notificationText.getText().length()==0){
						notificationText.setTextColor(Color.WHITE);
						}*/
						estimate = lastBgReading.calculatedValue;
						currentBgLabelText = BgGraphBuilder.unitizedString(estimate, true);
						var slope_arrow:String = lastBgReading.slopeArrow();
						if (lastBgReading.hideSlope) {
							slope_arrow = "";
						}
						currentBgLabelText += " " + slope_arrow;
						//currentBgLabel.setStyle("lineThrough","false");
					}
					var minutes:Number = ((new Date()).valueOf() - lastBgReading.timestamp) / (60 * 1000);
					var minutesString:String = minutes==1 ?" Minute ago":" Minutes ago";
					
					/// TODO complete this as in Android version
					//notificationText.append("\n" + minutes + minutesString);
					/*List<BgReading> bgReadingList = BgReading.latest(2);
					if(bgReadingList != null && bgReadingList.size() == 2) {
					// same logic as in xDripWidget (refactor that to BGReadings to avoid redundancy / later inconsistencies)?
					if(BgGraphBuilder.isXLargeTablet(getApplicationContext()) || BgGraphBuilder.isLargeTablet(getApplicationContext())) {
					notificationText.append("  ");
					} else {
					notificationText.append("\n");
					}
					notificationText.append(
					bgGraphBuilder.unitizedDeltaString(true, true));
					}
					if(bgGraphBuilder.unitized(estimate) <= bgGraphBuilder.lowMark) {
					currentBgLabelText.setTextColor(Color.parseColor("#FF0000"));
					} else if (bgGraphBuilder.unitized(estimate) >= bgGraphBuilder.highMark) {
					currentBgLabelText.setTextColor(Color.parseColor("#FFFF00"));
					} else {
					currentBgLabelText.setTextColor(Color.WHITE);
					}*/
				}
			}
			
			private function calibrationButtonClicked(e:MouseEvent = null):void {
				if (!_calibrateButtonActive)
					return;
				CalibrationService.calibrationOnRequest();
			}
			
			private function bluetoothButtonClicked(e:MouseEvent = null):void {
				var actionsheetBuilder:ActionSheetBuilder = new ActionSheetBuilder();;
					
				actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','view_device_status'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_STATUS);
					
				if (!BluetoothService.bluetoothPeripheralActive()) {
					//this is the case where bluetoothdevice is known or not, time for a scan
					actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','scan_for_device'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_SCAN_FOR_DEVICE);
				} else {
					//TODO hier zit nog iets verkeerd, die state blijft precies connected, ook al is 'm niet connected
					if (BluetoothService.getActiveBluetoothPeripheral().state != PeripheralState.CONNECTED && BluetoothLE.service.centralManager.state == BluetoothLEState.STATE_ON) {
						actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','connect_now'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_CONNECT_TO_DEVICE);
					}
				}
				
				if (BlueToothDevice.known()) {
					actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','forget_device'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_FORGET_DEVICE);
				}
				
				if (Sensor.getActiveSensor() == null) {
					actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','start_sensor'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_START_SENSOR);
				} else {
					actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('homeview','stop_sensor'), DialogAction.STYLE_DEFAULT, ACTION_SHEET_INDEX_FOR_STOP_SENSOR);
				}
				
				actionsheetBuilder.addAction(ModelLocator.resourceManagerInstance.getString('general','cancel'),DialogAction.STYLE_CANCEL, ACTION_SHEET_INDEX_FOR_CANCEL);
				
				var actionSheet:DialogView = Dialog.service.create(actionsheetBuilder.build());
				actionSheet.addEventListener(DialogViewEvent.CLOSED, actionSheet_closedHandler);
				actionSheet.show();
			}
			
			private function actionSheet_closedHandler( event:DialogViewEvent ):void {
				var actionSheet:DialogView = DialogView(event.currentTarget);
				actionSheet.removeEventListener(DialogViewEvent.CLOSED, actionSheet_closedHandler);
				actionSheet.dispose();
				
				if (event.index == ACTION_SHEET_INDEX_FOR_SCAN_FOR_DEVICE) {
					//TODO add a check if bluetooth is on, if not give warning message and don't start scanning
					if (BluetoothLE.service.centralManager.state == BluetoothLEState.STATE_ON) {
						BluetoothService.instance.addEventListener(BlueToothServiceEvent.STOPPED_SCANNING, scanningStopped);
						BluetoothService.startScanning();
					} else {
						var alert:DialogView = Dialog.service.create(
							new AlertBuilder()
							.setTitle(ModelLocator.resourceManagerInstance.getString("homeview","scanning_failed_tile"))
							.setMessage(ModelLocator.resourceManagerInstance.getString("homeview","bluetooth_not_switched_on"))
							.addOption("Ok", DialogAction.STYLE_POSITIVE, 0)
							.build()
						);
						DialogService.addDialog(alert, 30);
					}
				} else if (event.index == ACTION_SHEET_INDEX_FOR_FORGET_DEVICE) {
					BlueToothDevice.forgetBlueToothDevice();
				} else if (event.index == ACTION_SHEET_INDEX_FOR_START_SENSOR) {
					Sensor.startSensor();
				} else if (event.index == ACTION_SHEET_INDEX_FOR_STOP_SENSOR) {
					Sensor.stopSensor();
				} else if (event.index == ACTION_SHEET_INDEX_FOR_CONNECT_TO_DEVICE) {
					BluetoothService.tryReconnect();
				}
			}
			
			private static function scanningStopped(event:Event):void {
				BluetoothService.instance.removeEventListener(BlueToothServiceEvent.STOPPED_SCANNING, scanningStopped);
				if (!BluetoothService.bluetoothPeripheralActive()) {
					//create alert to get the user's input
					var alert:DialogView = Dialog.service.create(
						new AlertBuilder()
						.setTitle(ModelLocator.resourceManagerInstance.getString("homeview","scanning_failed_tile"))
						.setMessage(ModelLocator.resourceManagerInstance.getString("homeview","scanning_failed")
							+
							(BlueToothDevice.known() ? (" " + ModelLocator.resourceManagerInstance.getString("homeview","with_name") + " " + BlueToothDevice.name) + 
								"\n\n" + ModelLocator.resourceManagerInstance.getString("homeview","explain_expected_device_name"): "")
						)
						.addOption("Ok", DialogAction.STYLE_POSITIVE, 0)
						.build()
					);
					DialogService.addDialog(alert, 30);
				}
			}

			
		]]>
	</fx:Script>
	<s:actionContent>
		<s:Button icon="{ModelLocator.image_bluetooth_red}" id="bluetoothButton" click="bluetoothButtonClicked(event)"/>
		<s:Button icon="{ModelLocator.image_calibrate_active}" id="calibrateButton" alpha="{_calibrateButtonActive ? 1:0.25}" enabled="{_calibrateButtonActive}" click="calibrationButtonClicked(event)"/>
	</s:actionContent>
	
	<s:Group y="0" x="0" width="100%" height="100%" left="5" top="5" right="5">
		<s:layout>
			<s:VerticalLayout/>
		</s:layout>
		<s:Group width="100%">
			<s:layout>
				<s:HorizontalLayout paddingTop="5" paddingBottom="5" paddingLeft="5" paddingRight="5" gap="5" 
									horizontalAlign="right" verticalAlign="middle"/>
			</s:layout>
			<s:Group width="100%">
				<s:layout>
					<s:HorizontalLayout paddingTop="0" paddingBottom="0" paddingLeft="0" paddingRight="0" gap="0" 
										horizontalAlign="left" verticalAlign="middle"/>
				</s:layout>
				<s:Group>
					<s:layout>
						<s:VerticalLayout>
							
						</s:VerticalLayout>
					</s:layout>
					<s:Label id = "notificationText" text="test1"/>
					<s:Label id = "notificationText2" text="test2"/>
				</s:Group>
			</s:Group>
			<s:Label id = "currentBgLabel" text="{currentBgLabelText}" fontSize="70"/>
		</s:Group>
	</s:Group>
</s:View>
